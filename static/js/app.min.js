(function(){var global,__slice=[].slice;global=this;$.fn.add_or_remove_class=function(){var args,do_add,f;do_add=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];if(do_add){f=this.addClass}else{f=this.removeClass}return f.apply(this,args)};_.mixin({from_mongo:function(object_or_array){var obj;if(_.isArray(object_or_array)){return _.map(object_or_array,function(value){return _.from_mongo(value)})}else if(_.isObject(object_or_array)){if(object_or_array.$oid!=null){return object_or_array.$oid}else if(object_or_array.$date!=null){return moment(object_or_array.$date)}else{obj={};_.each(object_or_array,function(value,key){return this[key]=_.from_mongo(value)},obj);return obj}}else{return object_or_array}}})}).call(this);(function(){var Photo,PhotoList,PhotoListView,PhotoView,SiteTopView,TopPhotoList,UserLikePhotoList,WhoView,YTLRouter,global;global=this;Photo=Backbone.Model.extend({idAttribute:"_id",parse:function(attrs){return _.from_mongo(attrs)},get_thumbnail:function(size){return _.sortBy(this.get("photos")[0]["alt_sizes"],function(p){return Math.abs(p.width-size)})[0]}});PhotoList=Backbone.Collection.extend({model:Photo,parse:function(response){return response.photos},load_more:function(options){return this.fetch(_.extend({update:true,remove:false,data:{skip:this.length}},options||{}))}});TopPhotoList=PhotoList.extend({url:"/photos"});UserLikePhotoList=PhotoList.extend({initialize:function(options){this.who=options.who;return this.url="/who/"+this.who+"/photos"}});PhotoView=Backbone.View.extend({template:_.template($("#template-photo").html()),render:function(options){var ctxt;ctxt=_.extend({_view:this,options:options},this.model);this.$el.html(this.template(ctxt));return this}});PhotoListView=Backbone.View.extend({initialize:function(options){var _this=this;this.loading=false;this.collection.on("add",this.add_photo,this);this.collection.on("reset",this.reset_photo_list,this);this.watch_tail();return this.$el.on("tail_reached",function(){return _this.on_tail_reached()}).masonry({itemSelecotr:"li",columnWidth:250,isFitWidth:true})},add_photo:function(photo,collection,options){var $new_node,photoview;$new_node=$('<li class="photo" />');photoview=new PhotoView({el:$new_node,model:photo});photoview.render();return this.$el.append($new_node).masonry("appended",$new_node)},reset_photo_list:function(collection,options){var _this=this;collection.forEach(function(photo){return _this.add_photo(photo,collection)});return this.$el.imagesLoaded(function(){return _this.$el.masonry("reload")})},load_more:function(){var _this=this;if(this.loading){return}return this.collection.load_more({success:function(collection,resp,options){return _this.$el.imagesLoaded(function(){return _this.$el.masonry("reload")})},complete:function(xhr,status){return _this.loading=false}})},on_tail_reached:function(){return this.load_more()},watch_tail:function(){var settings,tail_reached,_test,_this=this;settings={threshold:64,container:window};_test=function(){var bottom,height;height=$(document).height();bottom=$(window).height()+window.scrollY;if(bottom>height-settings.threshold){return true}else{return false}};tail_reached=_test();return $(window).on("scroll",function(){if(tail_reached){if(!_test()){return tail_reached=false}}else{if(_test()){tail_reached=true;return _this.$el.trigger("tail_reached")}}})}});SiteTopView=Backbone.View.extend({template:_.template($("#template-contents-site_top").html()),events:{"keydown input#who-liked":"on_keydown_who_liked"},initialize:function(options){var photolist,view;this.render();this.$who=$("input#who-liked");photolist=this.make_photo_list(options);window.view=view=new PhotoListView({el:this.$el.find("#top-photo-list"),collection:photolist});return photolist.fetch()},make_photo_list:function(options){return new TopPhotoList},render:function(){var ctxt;ctxt=_.extend({_view:this});this.$el.html(this.template(ctxt));return this},on_keydown_who_liked:function(e){var who;if(e.keyCode===13){who=this.$who.val();if(who){return global.router.navigate("who/"+who,{trigger:true})}}}});WhoView=SiteTopView.extend({template:_.template($("#template-contents-who").html()),initialize:function(options){var _this=this;SiteTopView.prototype.initialize.call(this,options);this.$who.val(options.who);return $.ajax("/who/"+options.who+"/similars").success(function(response){var html;html=_.map(response.similars,function(user){return'<li><a href="/who/'+user+'">'+user+"</a></li>"});return _this.$el.find("#who-similar-to-you ul.users").html(html.join("\n"))})},make_photo_list:function(options){return new UserLikePhotoList({who:options.who})}});YTLRouter=Backbone.Router.extend({routes:{"":"top","who/:who":"who"},top:function(){var view;return view=new SiteTopView({el:$("#contents").html("")})},who:function(who){var view;return view=new WhoView({who:who,el:$("#contents").html("")})}});this.router=new YTLRouter;$(function(){if(!window.is_debug){$("#debug").remove()}return Backbone.history.start({pushState:true})})}).call(this);